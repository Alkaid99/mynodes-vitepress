# 触发器

MySQL 触发器是与表事件相关的**特殊存储过程**，触发器和存储过程一样能够完成特定的功能、存储在数据库服务器上的 SQL 片段，但触发器它的执行不由程序调用，也非手工启动，当对数据库表中的数据执行 DML 操作时会自动触发这个 SQL 片段的执行，无需手动调用。

触发器可以在 `insert`、 `update`、 `delete` 之前或之后触发并执行触发器中定义的 SQL 语句。例如，可以设置在 `INSERT` 表之前检测操作者是否输入错误数据、在 `UPDATE` 时，记录操作者的行为 `log` ，以及在 `DELETE` 时，判断删除的信息是否符合删除规则。这三类操作都可以使用 MySQL 触发器来实现。

触发器这种特性可以协助应用在数据库端确保数据的完整，日志记录，数据校验等操作。

**触发器的优点：**

- SQL 触发器提供了另一种检查数据完整性的方法。
- SQL 触发器可以捕获数据库层中业务逻辑中的错误。
- SQL 触发器提供了另一种运行计划任务的方法。通过使用 SQL 触发器，您不必等待运行计划任务，因为在对表中的数据进行更改之前或之后会自动调用触发器。
- SQL 触发器对于审计表中数据的更改非常有用。

**触发器的缺点：**

- SQL 触发器只能提供扩展验证，并且不能替换所有验证。必须在应用程序层中完成一些简单的验证。例如，您可以使用 JavaScript 在客户端验证用户的输入，或者使用服务器端脚本语言（如 JSP，PHP，ASP.NET，Perl）在服务器端验证用户的输入。
- 从客户端应用程序调用和执行 SQL 触发器是不可见的，因此很难弄清楚数据库层中发生了什么。
- SQL 触发器可能会增加数据库服务器的开销。
- MySQL 触发器只支持行级触发，不支持语句级触发。这是一个重要的限制，因为它意味着触发器在每行数据更改时都会执行，而不是在整个 SQL 语句执行后执行一次。这可能会影响性能，特别是在处理大量数据时。

## 触发器定义

在 MySQL 中，触发器是一组 SQL 语句，当对关联表上的数据进行更改时会自动调用这些语句。可以定义触发器在 `INSERT`，`UPDATE` 或 `DELETE` 语句更改数据之前或之后调用。在 MySQL 5.7.2 版之前，可以为每个表定义最多六个触发器。

| 语句            | 作用                       |
| --------------- | -------------------------- |
| `BEFORE INSERT` | 在将数据插入表格之前激活。 |
| `AFTER INSERT`  | 将数据插入表格后激活。     |
| `BEFORE UPDATE` | 在更新表中的数据之前激活。 |
| `AFTER UPDATE`  | 更新表中的数据后激活。     |
| `BEFORE DELETE` | 在从表中删除数据之前激活。 |
| `AFTER DELETE`  | 从表中删除数据后激活。     |

但是，从 MySQL 版本 5.7.2+ 开始，可以为同一触发事件和操作时间定义多个触发器。当使用不使用语句 `INSERT`，`DELETE` 或 `UPDATE` 语句来修改表中的数据，与表关联的触发器不被调用。

例如，`TRUNCATE` 语句删除表的所有数据，但不调用与表关联的触发器。有一些语句使用 `INSERT` 其它语句，如 `REPLACE` 语句或 `LOAD DATA` 语句。如果使用这些语句，则会调用与表关联的相应触发器。必须为与表关联的每个触发器使用唯一名称。但是，可以为不同的表定义相同的触发器名称，但这是一种很好的做法。应使用以下命名约定命名触发器：

```sql
(BEFORE | AFTER)_tableName_(INSERT| UPDATE | DELETE) 
```

例如，`before_order_update` 是在 `order` 更新表中的行之前调用的触发器。以下命名约定与上面的命名约定一样好。

```sql
tablename_(BEFORE | AFTER)_(INSERT| UPDATE | DELETE) 
```

例如，`order_before_update` 与 `before_order_update` 上面的触发器相同。

### MySQL 触发存储

MySQL 将触发器存储在数据目录中，例如，`/data/mysqldemo/` 使用名为的文件 `tablename.TRG` 和 `triggername.TRN`：

- `tablename.TRG` 文件将触发器映射到相应的表。
- `triggername.TRN` 文件包含触发器定义。

可以通过将触发器文件复制到备份文件夹来备份 MySQL 触发器。还可以使用 `mysqldump` 工具备份触发器。

### MySQL 触发器限制

MySQL 触发器涵盖标准 SQL 中定义的所有功能。但是，在应用程序中使用它们之前，应了解一些限制。

- 不能使用 `SHOW`，`LOAD DATA`，`LOAD TABLE`，`BACKUP DATABASE`，`RESTORE`，`FLUSH` 和 `RETURN` 语句。
- 不能使用隐式或显式提交或回滚的语句，例如 `COMMIT`，`ROLLBACK`，`START TRANSACTION`，`TABLES，ALTER，CREATE`，`DROP` 和 `RENAME` 语句。
- 不能使用 `PREPARE` 和 `EXECUTE` 之类的准备语句。
- 不能使用动态 SQL 语句。

从 MySQL 版本 5.1.4 开始，触发器可以调用存储过程或存储函数，这是以前版本的限制。这些限制是为了确保数据库的稳定性和数据的完整性。在设计和实现触发器时，需要考虑到这些限制。

